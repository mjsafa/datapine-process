{"processDefinition":{"name":"marketing-breakdown-metrics","steps":[{"type":"DbSelect","name":"get_ad_ids_from_db","properties":{"tableName":"general_fields","distinctOn":["ad_id"],"predicates":[],"batchSize":3},"outputs":[{"name":"success","destination":"to_json","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"ToJson","name":"to_json","properties":{},"outputs":[{"name":"success","destination":"split_breakdown_types","condition":null}],"itemAttributes":{"idsFlowItem":"@{item.content}"},"extendsStep":null},{"type":"SplitJsonArray","name":"split_breakdown_types","properties":{"array":"@{['age','country', 'gender']}"},"outputs":[{"name":"success","destination":"create_batch_request_breakdown","condition":null}],"itemAttributes":{"breakdownType":"@{item.content}"},"extendsStep":null},{"type":"ModifyJsonItems","name":"create_batch_request_breakdown","properties":{"array":"@{evalJson(item.attributes.idsFlowItem, '$')}","arrayItemExpression":{"url":"@{element.ad_id}/insights","isSingleObject":false,"parameters":{"time_increment":1,"level":"ad","time_range[since]":"@{extractor.lastExecution != null ? formatDate(extractor.lastExecution.minusDays(config.daysToExtract), 'yyyy-MM-dd') : '2015-01-01'}","time_range[until]":"@{formatDate(now(), 'yyyy-MM-dd')}","limit":500,"breakdowns":"@{item.attributes.breakdownType}"},"fields":["account_id","ad_id","adset_id","campaign_id","date_start","inline_link_clicks","impressions","spend","clicks","action_values","actions"]}},"outputs":[{"name":"success","destination":"request_insights","condition":null}],"itemAttributes":{"isBreakdown":true},"extendsStep":null},{"type":"FacebookMarketing","name":"request_insights","properties":{"batchRequests":"@{evalJson(item, '$')}"},"outputs":[{"name":"success","destination":"split_insights","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"SplitJsonArray","name":"split_insights","properties":{"array":"@{evalJson(item, '$.data')}"},"outputs":[{"name":"success","destination":"map_insights","condition":null}],"itemAttributes":{"like":"@{evalJson(item, '$.actions[?(@.action_type == \\'like\\')].value')}","link_click":"@{evalJson(item, '$.actions[?(@.action_type == \\'link_click\\')].value')}","post":"@{evalJson(item, '$.actions[?(@.action_type == \\'post\\')].value')}","post_like":"@{evalJson(item, '$.actions[?(@.action_type == \\'post_like\\' || @.action_type == \\'post_reaction\\')].value')}","page_engagement":"@{evalJson(item, '$.actions[?(@.action_type == \\'page_engagement\\')].value')}","post_engagement":"@{evalJson(item, '$.actions[?(@.action_type == \\'post_engagement\\')].value')}"},"extendsStep":null},{"type":"ToMap","name":"map_insights","properties":{"mappings":{"ad_id":"@{evalJson(item, '$.ad_id')}","clicks":"@{evalJson(item, '$.clicks')}","impressions":"@{evalJson(item, '$.impressions')}","spend":"@{evalJson(item, '$.spend')}","is_breakdown":"@{item.attributes.isBreakdown == 'true' ? true : false}","age":"@{evalJson(item, '$.age')}","gender":"@{evalJson(item, '$.gender')}","country":"@{evalJson(item, '$.country')}","date_start":"@{toDate(evalJson(item, '$.date_start'), 'yyyy-MM-dd')}","action_like":"@{listItem(item.attributes.?like, 0, null)}","action_link_click":"@{listItem(item.attributes.?link_click, 0, null)}","action_post":"@{listItem(item.attributes.?post, 0, null)}","action_post_like":"@{listItem(item.attributes.?post_like, 0, null)}","action_page_engagement":"@{listItem(item.attributes.?page_engagement, 0, null)}","action_post_engagement":"@{listItem(item.attributes.?post_engagement, 0, null)}","total_action_value":"@{sumDouble(evalJson(item, '$.action_values[*].value') , '0')}"}},"outputs":[{"name":"success","destination":"save_insights","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"InsertMapIntoDB","name":"save_insights","properties":{"tableName":"general_fields","batchSize":500,"fields":["ad_id","clicks","impressions","spend","is_breakdown","age","gender","country","date_start","action_like","action_link_click","action_post","action_post_like","action_page_engagement","action_post_engagement","total_action_value"]},"outputs":[],"itemAttributes":{},"extendsStep":null}],"excludes":[],"generalSteps":[],"dependencies":["marketing-ads-metrics"],"ignoreExceptionTypes":null,"exceptionIgnoreExpression":null},"extractor":{"id":0,"publicId":null,"lastExecution":null,"startExecution":null,"finishExecution":null,"queuedExecution":null,"timeUnit":null,"timePeriod":0,"active":false,"status":null,"message":null,"errorCounter":0,"fullExtraction":true},"connectorCredentials":{"id":0,"organizationId":38,"datasourceId":1045498,"connectorType":"FACEBOOK_MARKETING","creationDate":null,"refreshToken":"EAAGuoVILSX4BABrwgGpCfYZBDXybShMM89BXZBCWspYDfDwIXu1NQUH5hAlKQ5ZALpVnvrStOIRWz0FqqRB4MreonlxmJ27NABGN7ev1tDz9qA8LuB7IEuQF2d2oxnZCYhao8IBZAJWvrG9l07N7mkcxaN7YBtGfsqtmJugsLLtvSFnOTb6Io","datamart":"localhost","config":"{\"properties\":{\"pageId\":\"+ExoplatformTribe\",\"domain\":\"mettrr\",\"customFields\":[{\"id\":360001124611,\"title\":\"3rd Line Tech Support (UK) Type of Change/Request\"},{\"id\":360001486852,\"title\":\"3rd Line Adwords management Type of Change/Request\"},{\"id\":360001486872,\"title\":\"3rd Line Product support Type of Change/Request\"},{\"id\":360001063512,\"title\":\"2nd Line Legacy CWT Type of Change/Request\"},{\"id\":360002165852,\"title\":\"Mark as Spam\"},{\"id\":360001063532,\"title\":\"3rd Line Accounts and Admin (UK) Type of Change/Request\"},{\"id\":360001062512,\"title\":\"2nd Line CWT Type of Change/Request\"},{\"id\":360001123991,\"title\":\"1st Line Type of Change/Request\"},{\"id\":360001124771,\"title\":\"3rd Line Content (UK) Type of Change/Request\"},{\"id\":360001227172,\"title\":\"Country\"},{\"id\":360001124011,\"title\":\"2nd Line CTT Type of Change/Request\"},{\"id\":360001227992,\"title\":\"Phone Number - Only from form submission\"}],\"clientCustomerIds\":[\"8049594734\"],\"reports\":[\"ACCOUNT_PERFORMANCE_REPORT_Normal\"]},\"to\":[],\"oauthAccessTokenSecret\":\"oLZCb0LjGWAmmTONV8ciiz9f6ng488dncQps2h1eo2s2D\"}","extractor":null}}