{"processDefinition":{"name":"youtube-analytics","steps":[{"type":"DbSelect","name":"select_video_ids","properties":{"tableName":"Videos","fields":["id"],"batchSize":200,"predicates":[]},"outputs":[{"name":"success","destination":"video_report_interval"},{"name":"success","destination":"every_day_interval"}],"itemAttributes":{"videoId":"@{joinToString(evalJson(toJson(item.content), '$[*].Id'), ',')}","videoIdList":"@{evalJson(toJson(item.content), '$[*].Id')}"},"x":0,"y":0},{"type":"GetIntervals","name":"every_day_interval","properties":{"totalMonths":24,"batchDays":1000,"daysToExtract":1},"outputs":[{"name":"success","destination":"clean_reports_1"}],"itemAttributes":{"startDate":"@{formatDate(item.content.from, 'yyyy-MM-dd')}","endDate":"@{formatDate(item.content.until.plusDays(1), 'yyyy-MM-dd')}"},"x":270,"y":0},{"type":"DeleteFromDB","name":"clean_reports_1","properties":{"tables":["AudienceRetention","UserGeography","Demographics","EngagementReports"],"predicates":[{"field":"VideoId","operator":"in","value":"@{item.attributes.videoIdList}"}]},"outputs":[{"name":"success","destination":"geography_report"},{"name":"success","destination":"demographic_report"},{"name":"success","destination":"report_engagement"},{"name":"success","destination":"split_video_ids"}],"itemAttributes":{},"x":540,"y":0},{"type":"SplitJsonArray","name":"split_video_ids","properties":{"array":"@{item.attributes.videoIdList}"},"outputs":[{"name":"success","destination":"audience_retention"}],"itemAttributes":{"videoId":"@{item.content}"},"x":810,"y":0},{"type":"YouTubeAnalytics","name":"audience_retention","properties":{"url":"reports","params":{"dimensions":"elapsedVideoTimeRatio","filters":"video==@{item.attributes.videoId}","ids":"channel==MINE","metrics":"audienceWatchRatio,relativeRetentionPerformance","startDate":"@{item.attributes.startDate}","endDate":"@{item.attributes.endDate}"}},"outputs":[{"name":"success","destination":"process_rows_without_day"}],"itemAttributes":{"table":"AudienceRetention","fields":"@{['VideoId', 'ElapsedVideoTimeRatio','AudienceWatchRatio','RelativeRetentionPerformance']}"},"x":1080,"y":0},{"type":"YouTubeAnalytics","name":"geography_report","properties":{"url":"reports","params":{"dimensions":"country,video","filters":"video==@{item.attributes.videoId}","ids":"channel==MINE","metrics":"views,estimatedMinutesWatched,averageViewDuration,averageViewPercentage,comments,likes,dislikes,shares,subscribersGained,subscribersLost","startDate":"@{item.attributes.startDate}","endDate":"@{item.attributes.endDate}"}},"outputs":[{"name":"success","destination":"process_rows_without_day"}],"itemAttributes":{"table":"UserGeography","fields":"@{['VideoId', 'Country', 'Views','EstimatedMinutesWatched','AverageViewDuration','AverageViewPercentage','Comments','Likes','Dislikes','Shares','SubscribersGained','SubscribersLost']}"},"x":810,"y":120},{"type":"YouTubeAnalytics","name":"demographic_report","properties":{"url":"reports","params":{"dimensions":"ageGroup,gender,liveOrOnDemand,video","filters":"video==@{item.attributes.videoId}","ids":"channel==MINE","metrics":"viewerPercentage","startDate":"@{item.attributes.startDate}","endDate":"@{item.attributes.endDate}"}},"outputs":[{"name":"success","destination":"process_rows_without_day"}],"itemAttributes":{"table":"Demographics","fields":"@{['VideoId', 'AgeGroup', 'Gender', 'LiveOrOnDemand', 'ViewerPercentage']}"},"x":810,"y":240,"propertiesString":"{\n\t\"url\": \"reports\",\n\t\"params\": {\n\t\t\"dimensions\": \"ageGroup,gender,liveOrOnDemand,video\",\n\t\t\"filters\": \"video==@{item.attributes.videoId}\",\n\t\t\"ids\": \"channel==MINE\",\n\t\t\"metrics\": \"viewerPercentage\",\n\t\t\"startDate\": \"@{item.attributes.startDate}\",\n\t\t\"endDate\": \"@{item.attributes.endDate}\"\n\t}\n}","attributesString":"{\n\t\"table\": \"Demographics\",\n\t\"fields\": \"@{['VideoId', 'AgeGroup', 'Gender', 'LiveOrOnDemand', 'ViewerPercentage']}\"\n}"},{"type":"YouTubeAnalytics","name":"report_engagement","properties":{"url":"reports","params":{"dimensions":"sharingService,video","filters":"video==@{item.attributes.videoId}","ids":"channel==MINE","metrics":"shares","startDate":"@{item.attributes.startDate}","endDate":"@{item.attributes.endDate}"}},"outputs":[{"name":"success","destination":"process_rows_without_day"}],"itemAttributes":{"table":"EngagementReports","fields":"@{['VideoId', 'SharingService','Shares']}"},"x":810,"y":360},{"type":"CreateJsonObjects","name":"process_rows_without_day","properties":{"keys":"@{evalJson(item, '$.columnHeaders[*].name')}","values":"@{evalJson(item, '$.rows')}","multiple":true},"outputs":[{"name":"success","destination":"upper_keys2"}],"itemAttributes":{},"x":1080,"y":360},{"type":"ModifyJsonItems","name":"upper_keys2","properties":{"keyExpression":"${upperFirstLetter(key)}"},"outputs":[{"name":"success","destination":"map_rows_2"}],"itemAttributes":{},"x":1350,"y":360},{"type":"JsonToMap","name":"map_rows_2","properties":{"mappings":{"Day":"@{toDate(item.attributes.startDate, 'yyyy-MM-dd').atStartOfDay()}","VideoId":"@{null != evalJson(item, '$.Video') ? evalJson(item, '$.Video') : item.attributes.videoId}"},"excludes":["Video"]},"outputs":[{"name":"success","destination":"save_reports_2"}],"itemAttributes":{},"x":1620,"y":360},{"type":"InsertMapIntoDB","name":"save_reports_2","properties":{"tableName":"@{item.attributes.table}","batchSize":400,"fields":"@{item.attributes.fields}"},"outputs":[],"itemAttributes":{},"x":1890,"y":360},{"type":"GetIntervals","name":"video_report_interval","properties":{"totalMonths":3,"batchDays":90,"daysToExtract":3},"outputs":[{"name":"success","destination":"clean_rows"}],"itemAttributes":{"startDate":"@{formatDate(item.content.from, 'yyyy-MM-dd')}","endDate":"@{formatDate(item.content.until.plusDays(1), 'yyyy-MM-dd')}"},"x":270,"y":480},{"type":"YouTubeAnalytics","name":"traffic_sources_report","properties":{"url":"reports","params":{"dimensions":"day,insightTrafficSourceType,liveOrOnDemand","filters":"video==@{item.attributes.videoId}","ids":"channel==MINE","metrics":"views,estimatedMinutesWatched","startDate":"@{item.attributes.startDate}","endDate":"@{item.attributes.endDate}"}},"outputs":[{"name":"success","destination":"process_rows"}],"itemAttributes":{"table":"TrafficSources"},"x":810,"y":480},{"type":"DeleteFromDB","name":"clean_rows","properties":{"tables":["TrafficSources","TimeBasedReports","Devices"],"predicates":[{"field":"Day","operator":">=","value":"@{toDate(item.attributes.startDate, 'yyyy-MM-dd').atStartOfDay()}"},{"field":"Day","operator":"<","value":"@{toDate(item.attributes.endDate, 'yyyy-MM-dd').atStartOfDay()}"},{"field":"VideoId","operator":"=","value":"@{item.attributes.videoId}"}]},"outputs":[{"name":"success","destination":"report_device"},{"name":"success","destination":"traffic_sources_report"},{"name":"success","destination":"report_timebased"}],"itemAttributes":{},"x":540,"y":480},{"type":"YouTubeAnalytics","name":"report_device","properties":{"url":"reports","params":{"dimensions":"deviceType,liveOrOnDemand,youtubeProduct,day","filters":"video==@{item.attributes.videoId}","ids":"channel==MINE","metrics":"views,estimatedMinutesWatched","startDate":"@{item.attributes.startDate}","endDate":"@{item.attributes.endDate}"}},"outputs":[{"name":"success","destination":"process_rows"}],"itemAttributes":{"table":"Devices"},"x":810,"y":600},{"type":"YouTubeAnalytics","name":"report_timebased","properties":{"url":"reports","params":{"dimensions":"day","filters":"video==@{item.attributes.videoId}","ids":"channel==MINE","metrics":"views,estimatedMinutesWatched,averageViewDuration,averageViewPercentage,comments,likes,dislikes,shares,subscribersGained,subscribersLost","startDate":"@{item.attributes.startDate}","endDate":"@{item.attributes.endDate}"}},"outputs":[{"name":"success","destination":"process_rows"}],"itemAttributes":{"table":"TimeBasedReports"},"x":810,"y":720},{"type":"CreateJsonObjects","name":"process_rows","properties":{"keys":"@{evalJson(item, '$.columnHeaders[*].name')}","values":"@{evalJson(item, '$.rows')}","multiple":true},"outputs":[{"name":"success","destination":"upper_keys"}],"itemAttributes":{},"x":1080,"y":720},{"type":"ModifyJsonItems","name":"upper_keys","properties":{"keyExpression":"${upperFirstLetter(key)}"},"outputs":[{"name":"success","destination":"map_row"}],"itemAttributes":{},"x":1350,"y":720},{"type":"JsonToMap","name":"map_row","properties":{"mappings":{"Day":"@{toDate(evalJson(item, '$.Day'), 'yyyy-MM-dd').atStartOfDay()}","VideoId":"@{item.attributes.videoId}"}},"outputs":[{"name":"success","destination":"save_reports"}],"itemAttributes":{},"x":1620,"y":720},{"type":"InsertMapIntoDB","name":"save_reports","properties":{"tableName":"@{item.attributes.table}","batchSize":200},"outputs":[],"itemAttributes":{},"x":1890,"y":720}],"excludes":["video_report_interval","report_engagement","geography_report","split_video_ids"],"generalSteps":[],"dependencies":["youtube_videos"]},"extractor":{"id":0,"timePeriod":0,"active":false,"errorCounter":0},"connectorCredentials":{"id":0,"organizationId":28,"datasourceId":99,"refreshToken":"1/68jkA449uGoqboSdv4j4Jz7PXDGeYU6JLBaB62tQAG8","datamart":"localhost","config":{"properties":{"pageId":"112263752521477124308","domain":"mettrr","customFields":[{"id":360001124611,"title":"3rd Line Tech Support (UK) Type of Change/Request"},{"id":360001486852,"title":"3rd Line Adwords management Type of Change/Request"},{"id":360001486872,"title":"3rd Line Product support Type of Change/Request"},{"id":360001063512,"title":"2nd Line Legacy CWT Type of Change/Request"},{"id":360002165852,"title":"Mark as Spam"},{"id":360001063532,"title":"3rd Line Accounts and Admin (UK) Type of Change/Request"},{"id":360001062512,"title":"2nd Line CWT Type of Change/Request"},{"id":360001123991,"title":"1st Line Type of Change/Request"},{"id":360001124771,"title":"3rd Line Content (UK) Type of Change/Request"},{"id":360001227172,"title":"Country"},{"id":360001124011,"title":"2nd Line CTT Type of Change/Request"},{"id":360001227992,"title":"Phone Number - Only from form submission"}],"clientCustomerIds":["8670301477"],"reports":["PLACEHOLDER_REPORT_Normal","PLACEMENT_PERFORMANCE_REPORT_Normal","PRODUCT_PARTITION_REPORT_Normal","SEARCH_QUERY_PERFORMANCE_REPORT_Normal","SHOPPING_PERFORMANCE_REPORT_ConversionSegmented","SHOPPING_PERFORMANCE_REPORT_Normal","TOP_CONTENT_PERFORMANCE_REPORT_Normal","URL_PERFORMANCE_REPORT_ConversionSegmented","URL_PERFORMANCE_REPORT_Normal","USER_AD_DISTANCE_REPORT_Normal","VIDEO_PERFORMANCE_REPORT_ConversionSegmented","VIDEO_PERFORMANCE_REPORT_Normal"]},"to":[],"oauthAccessTokenSecret":"oLZCb0LjGWAmmTONV8ciiz9f6ng488dncQps2h1eo2s2D"}}}