{"processDefinition":{"name":"twitter-organic-tweets-analytics","steps":[{"type":"TwitterConnector","name":"get_accounts","properties":{"resourceURL":"https://ads-api.twitter.com/4/accounts"},"outputs":[{"name":"success","destination":"split_accounts"}]},{"type":"SplitJsonArray","name":"split_accounts","properties":{"propertyJsonArray":"@{evalJson(item, '$.data')}"},"outputs":[{"name":"success","destination":"select_tweet_ids"},{"name":"success","destination":"select_promoted_organic_tweets"},{"name":"success","destination":"select_promoted_tweets"}],"itemAttributes":{"accountId":"@{evalJson(item, '$.id')}","timezone":"@{evalJson(item, '$.timezone')}"}},{"type":"DbSelect","name":"select_promoted_organic_tweets","properties":{"tableName":"OrganicTweets","fields":["id"],"batchSize":0,"predicates":[{"field":"type","value":"PROMOTED_ORGANIC","operator":"="}]},"outputs":[{"name":"success","destination":"to_json"}],"itemAttributes":{"entityType":"PROMOTED_ORGANIC","idsJsonPath":"$[*].id","isPromoted":false}},{"type":"DbSelect","name":"select_promoted_tweets","properties":{"tableName":"OrganicTweets","fields":["NumericId","id"],"batchSize":0,"predicates":[{"field":"type","value":"PROMOTED","operator":"="}]},"outputs":[{"name":"success","destination":"prmoted_ids_to_json"}],"itemAttributes":{"entityType":"PROMOTED","idsJsonPath":"$[*]","isPromoted":true}},{"type":"ToJson","name":"prmoted_ids_to_json","properties":{},"outputs":[{"name":"success","destination":"promoted_interval"}],"itemAttributes":{"idsJson":"@{item.content}"}},{"type":"GetIntervals","name":"promoted_interval","properties":{},"outputs":[{"name":"success","destination":"split_20_promoted_ids"}],"extendsStep":"analytic_intervals"},{"type":"SplitJsonArray","name":"split_20_promoted_ids","properties":{"propertyJsonArray":"@{evalJson(item.attributes.idsJson, item.attributes.idsJsonPath)}","batchSize":20},"outputs":[{"name":"success","destination":"entity_analytics"}],"itemAttributes":{"entityIds":"@{joinToString(evalJson(item, '$[*].NumericId'), ',')}","entityIdsList":"@{evalJson(item, '$[*].id')}"}},{"type":"DbSelect","name":"select_tweet_ids","properties":{"tableName":"OrganicTweets","fields":["id"],"batchSize":0,"predicates":[{"field":"created_at","operator":">=","value":"@{now().minusMonths(12)}"},{"field":"type","value":"ORGANIC","operator":"="}]},"outputs":[{"name":"success","destination":"to_json"}],"itemAttributes":{"entityType":"ORGANIC","idsJsonPath":"$[*].id","isPromoted":false}},{"type":"ToJson","name":"to_json","outputs":[{"name":"success","destination":"analytic_intervals"}],"itemAttributes":{"idsJson":"@{item.content}"}},{"name":"analytic_intervals","outputs":[{"name":"success","destination":"split_20_entities"}],"extendsStep":"analytic_intervals"},{"type":"DeleteFromDB","name":"cleanup_analytics","properties":{"tableName":"Metrics","predicates":[{"field":"entityId","value":"@{item.attributes.entityIdsList}","operator":"in"},{"field":"extraction_date","start":"@{toDateTime(item.attributes.analyticsStartDate, 'yyyy-MM-dd\\'T\\'HH:mm:ss\\'Z\\'' ).toLocalDate().atStartOfDay()}","end":"@{toDateTime(item.attributes.analyticsEndDate, 'yyyy-MM-dd\\'T\\'HH:mm:ss\\'Z\\'' ).toLocalDate().plusDays(1).atStartOfDay().minusMinutes(1)}","operator":"between"}]},"outputs":[{"name":"success","destination":"split_analytics"}],"itemAttributes":{}},{"type":"SplitJsonArray","name":"split_20_entities","properties":{"propertyJsonArray":"@{evalJson(item.attributes.idsJson, item.attributes.idsJsonPath)}","batchSize":20},"outputs":[{"name":"success","destination":"entity_analytics"}],"itemAttributes":{"entityIds":"@{joinToString(evalJson(item, '$'), ',')}","entityIdsList":"@{evalJson(item, '$')}"}},{"type":"TwitterAnalytics","name":"entity_analytics","properties":{"jobWaitTime":3000,"timezone":"@{item.attributes.timezone}","jobs":[{"accountId":"@{item.attributes.accountId}","start_time":"@{formatDate(item.attributes.from.plusDays(1), 'yyyy-MM-dd\\'T\\'HH:mm:ss\\'Z\\'')}","end_time":"@{formatDate(item.attributes.until.plusDays(1).plusHours(1), 'yyyy-MM-dd\\'T\\'HH:mm:ss\\'Z\\'')}","entity":"ORGANIC_TWEET","metric_groups":"ENGAGEMENT,VIDEO","placement":"ALL_ON_TWITTER","granularity":"DAY","entity_ids":"@{item.attributes.entityIds}"}]},"outputs":[{"name":"success","destination":"cleanup_analytics"}],"itemAttributes":{"analyticsStartDate":"@{evalJson(item, '$.request.params.start_time')}","analyticsEndDate":"@{evalJson(item, '$.request.params.end_time')}"}},{"type":"SplitJsonArray","name":"split_analytics","properties":{"propertyJsonArray":"@{evalJson(item, '$.data')}"},"outputs":[{"name":"success","destination":"process_analytics"}]},{"type":"MergeJsonArrays","name":"process_analytics","properties":{"arrays":{"engagements":"@{evalJson(item , '$.id_data[0].metrics.engagements')}","impressions":"@{evalJson(item , '$.id_data[0].metrics.impressions')}","retweets":"@{evalJson(item , '$.id_data[0].metrics.retweets')}","replies":"@{evalJson(item , '$.id_data[0].metrics.replies')}","likes":"@{evalJson(item , '$.id_data[0].metrics.likes')}","follows":"@{evalJson(item , '$.id_data[0].metrics.follows')}","card_engagements":"@{evalJson(item , '$.id_data[0].metrics.card_engagements')}","total_clicks":"@{evalJson(item , '$.id_data[0].metrics.clicks')}","app_clicks":"@{evalJson(item , '$.id_data[0].metrics.app_clicks')}","url_clicks":"@{evalJson(item , '$.id_data[0].metrics.url_clicks')}","qualified_impressions":"@{evalJson(item , '$.id_data[0].metrics.qualified_impressions')}","billed_engagements":"@{evalJson(item , '$.id_data[0].metrics.billed_engagements')}","billed_charge":"@{evalJson(item , '$.id_data[0].metrics.billed_charge_local_micro') != null ? evalJson(item , '$.id_data[0].metrics.billed_charge_local_micro')/1000000.0f : null}","video_total_views":"@{evalJson(item , '$.id_data[0].metrics.video_total_views')}","video_views_25":"@{evalJson(item , '$.id_data[0].metrics.video_views_25')}","video_views_50":"@{evalJson(item , '$.id_data[0].metrics.video_views_50')}","video_views_75":"@{evalJson(item , '$.id_data[0].metrics.video_views_75')}","video_views_100":"@{evalJson(item , '$.id_data[0].metrics.video_views_100')}","video_cta_clicks":"@{evalJson(item , '$.id_data[0].metrics.video_cta_clicks')}","video_content_starts":"@{evalJson(item , '$.id_data[0].metrics.video_content_starts')}","video_mrc_views":"@{evalJson(item , '$.id_data[0].metrics.video_mrc_views')}","video_3s100pct_views":"@{evalJson(item , '$.id_data[0].metrics.video_3s100pct_views')}"},"additionalJsonProperties":{"extraction_date":"@{formatDate(toDateTime(item.attributes.analyticsStartDate, 'yyyy-MM-dd\\'T\\'HH:mm:ss\\'Z\\'' ).toLocalDate().atStartOfDay().plusDays(index), 'yyyy-MM-dd\\'T\\'HH:mm:ss')}","entityId":"@{evalJson(item, '$.id')}","entity":"Organic"},"split":true},"outputs":[{"name":"success","destination":"analytics_to_map"}],"itemAttributes":{}},{"type":"JsonToMap","name":"analytics_to_map","properties":{"mappings":{"extraction_date":"@{toDateTime(evalJson(item, '$.extraction_date'), 'yyyy-MM-dd\\'T\\'HH:mm:ss')}","engagement_rate":"@{ evalJson(item, '$.impressions') > 0 ? (evalJson(item, '$.engagements')*1.0f) / (evalJson(item, '$.impressions')*1.0f) : 0}","promotedId":"@{item.attributes.isPromoted == 'true' ? listItem(evalJson(item.attributes.idsJson, '$[?(@.NumericId == \\''+ evalJson(item, '$.entityId') + '\\')].id'),0) : null}"}},"outputs":[{"name":"success","destination":"default_zero_values"}],"itemAttributes":{}},{"type":"Modify","name":"default_zero_values","properties":{"value":{"entity":"@{item.content.?entity}","entityId":"@{item.content.?promotedId != null ? item.content.?promotedId : item.content.?entityId}","extraction_date":"@{item.content.?extraction_date}","engagements":"@{item.content.?engagements != null ? item.content.?engagements : 0}","impressions":"@{item.content.?impressions != null ? item.content.?impressions : 0}","retweets":"@{item.content.?retweets != null ? item.content.?retweets : 0}","replies":"@{item.content.?replies != null ? item.content.?replies : 0}","likes":"@{item.content.?likes != null ? item.content.?likes : 0}","follows":"@{item.content.?follows != null ? item.content.?follows : 0}","card_engagements":"@{item.content.?card_engagements != null ? item.content.?card_engagements : 0}","total_clicks":"@{item.content.?total_clicks != null ? item.content.?total_clicks : 0}","app_clicks":"@{item.content.?app_clicks != null ? item.content.?app_clicks : 0}","url_clicks":"@{item.content.?url_clicks != null ? item.content.?url_clicks : 0}","qualified_impressions":"@{item.content.?qualified_impressions != null ? item.content.?qualified_impressions : 0}","billed_engagements":"@{item.content.?billed_engagements != null ? item.content.?billed_engagements : 0}","billed_charge":"@{item.content.?billed_charge != null ? item.content.?billed_charge : 0}","video_total_views":"@{item.content.?video_total_views != null ? item.content.?video_total_views : 0}","video_views_25":"@{item.content.?video_views_25 != null ? item.content.?video_views_25 : 0}","video_views_50":"@{item.content.?video_views_50 != null ? item.content.?video_views_50 : 0}","video_views_75":"@{item.content.?video_views_75 != null ? item.content.?video_views_75 : 0}","video_views_100":"@{item.content.?video_views_100 != null ? item.content.?video_views_100 : 0}","video_cta_clicks":"@{item.content.?video_cta_clicks != null ? item.content.?video_cta_clicks : 0}","video_content_starts":"@{item.content.?video_content_starts != null ? item.content.?video_content_starts : 0}","video_mrc_views":"@{item.content.?video_mrc_views != null ? item.content.?video_mrc_views : 0}","video_3s100pct_views":"@{item.content.?video_3s100pct_views != null ? item.content.?video_3s100pct_views : 0}","unfollows":"@{item.content.?unfollows != null ? item.content.?unfollows : 0}","engagement_rate":"@{item.content.?engagement_rate != null ? item.content.?engagement_rate : 0}"}},"outputs":[{"name":"success","destination":"save_analytics"}],"itemAttributes":{}},{"type":"InsertMapIntoDB","name":"save_analytics","properties":{"tableName":"Metrics","batchSize":200,"fields":["entity","entityId","extraction_date","engagements","impressions","retweets","replies","likes","follows","card_engagements","total_clicks","app_clicks","url_clicks","qualified_impressions","billed_engagements","billed_charge","video_total_views","video_views_25","video_views_50","video_views_75","video_views_100","video_cta_clicks","video_content_starts","video_mrc_views","video_3s100pct_views","unfollows","engagement_rate"]},"outputs":[],"itemAttributes":{}}],"excludes":["select_promoted_tweets"],"generalSteps":[{"type":"GetIntervals","name":"analytic_intervals","properties":{"totalMonths":6,"batchDays":90,"daysToExtract":3},"itemAttributes":{"from":"@{item.content.from}","until":"@{item.content.until}"}}],"dependencies":["get_organic_tweets"]},"extractor":{"id":0,"timePeriod":0,"active":false,"errorCounter":0},"connectorCredentials":{"id":0,"organizationId":38,"datasourceId":34505,"connectorType":"TWITTER","refreshToken":"1446344904-Qt79PlTuXh6mzuGg3sZGDaMJZZA1qvBYAgcNQ9B","datamart":"localhost","config":"{\"properties\":{\"reports\":[\"ACCOUNT_PERFORMANCE_REPORT_Normal\"],\"clientCustomerIds\":\"6241117324\"},\"to\":[],\"oauthAccessTokenSecret\": \"wetxpmGn7zPbWCaQZkEN2cqAjYcmEu4PuQ5c7RCoXD4Ko\"}"}}