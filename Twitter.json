{"processDefinition":{"name":"get_organic_tweets","steps":[{"type":"DbFunction","name":"max_tweet_id_in_DB","properties":{"field":"NumericId","function":"max","tableName":"OrganicTweets","predicates":[{"field":"type","value":"ORGANIC","operator":"="}]},"outputs":[{"name":"success","destination":"select_yesterday_stats","condition":null}],"itemAttributes":{"maxId":"@{item.content != null ? item.content : 0}"},"extendsStep":null},{"type":"DbSelect","name":"select_yesterday_stats","properties":{"tableName":"AccountStats","fields":["extraction_date","favouritesCount","followersCount","friendsCount","listedCount","statusesCount"],"batchSize":0,"passIfNotFound":true,"predicates":[{"field":"extraction_date","operator":"between","start":"@{now().minusDays(1).toLocalDate().atStartOfDay()}","end":"@{now().toLocalDate().atStartOfDay().minusSeconds(1)}"}]},"outputs":[{"name":"success","destination":"get_current_account","condition":null}],"itemAttributes":{"yesterdayStats":"@{item.content != null && !(item.content instanceof Number) && item.content.size > 0 ? item.content.get(0): null}"},"extendsStep":null},{"type":"TwitterConnector","name":"get_current_account","properties":{"resourceURL":"https://api.twitter.com/1.1/account/verify_credentials.json"},"outputs":[{"name":"success","destination":"read_tweets_timeline","condition":null},{"name":"success","destination":"clean_accounts","condition":null},{"name":"success","destination":"select_follower_ids_today","condition":null}],"itemAttributes":{"accountId":"@{evalJson(item, '$.id')}","accountItem":"@{item.content}"},"extendsStep":null},{"type":"DbSelect","name":"select_follower_ids_today","properties":{"tableName":"FollowerIds","fields":["followerId"],"batchSize":0,"passIfNotFound":true,"predicates":[{"field":"date","operator":"between","start":"@{currentDate().atStartOfDay()}","end":"@{now()}"},{"field":"accountId","operator":"=","value":"@{item.attributes.accountId}"}]},"outputs":[{"name":"success","destination":"today_followers_to_json","condition":null}],"itemAttributes":{"todayIds":"@{item.content}"},"extendsStep":null},{"type":"ToJson","name":"today_followers_to_json","properties":{},"outputs":[{"name":"success","destination":"select_follower_ids_yesterday","condition":null}],"itemAttributes":{"todayIdsJson":"@{item.content}"},"extendsStep":null},{"type":"DbSelect","name":"select_follower_ids_yesterday","properties":{"tableName":"FollowerIds","fields":["followerId"],"batchSize":0,"passIfNotFound":true,"predicates":[{"field":"date","operator":"between","start":"@{currentDate().minusDays(1).atStartOfDay()}","end":"@{currentDate().atStartOfDay()}"},{"field":"accountId","operator":"=","value":"@{item.attributes.accountId}"}]},"outputs":[{"name":"success","destination":"yesterday_followers_to_json","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"ToJson","name":"yesterday_followers_to_json","properties":{},"outputs":[{"name":"success","destination":"clean_account_stats","condition":null}],"itemAttributes":{"yesterdayIdsJson":"@{item.content}"},"extendsStep":null},{"type":"DeleteFromDB","name":"clean_account_stats","properties":{"tableName":"AccountStats","predicates":[{"field":"accountId","operator":"=","value":"@{item.attributes.accountId}"},{"field":"extraction_date","operator":"between","start":"@{currentDate().atStartOfDay()}","end":"@{now()}"}]},"outputs":[{"name":"success","destination":"map_account_stats","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"ToMap","name":"map_account_stats","properties":{"mappings":{"accountId":"@{item.attributes.accountId}","extraction_date":"@{now()}","favouritesCount":"@{evalJson(item.attributes.accountItem, '$.favourites_count')}","favouritesCount_adds":"@{item.attributes.?yesterdayStats != null ? evalJson(item.attributes.accountItem, '$.favourites_count') - item.attributes.yesterdayStats.favouritesCount : 0}","followersCount":"@{evalJson(item.attributes.accountItem, '$.followers_count')}","followersCount_adds":"@{item.attributes.?yesterdayStats != null ? evalJson(item.attributes.accountItem, '$.followers_count') - item.attributes.yesterdayStats.followersCount : 0}","friendsCount":"@{evalJson(item.attributes.accountItem, '$.friends_count')}","friendsCount_adds":"@{item.attributes.?yesterdayStats != null ? evalJson(item.attributes.accountItem, '$.friends_count') - item.attributes.yesterdayStats.friendsCount : 0}","listedCount":"@{evalJson(item.attributes.accountItem, '$.listed_count')}","listedCount_adds":"@{item.attributes.?yesterdayStats != null ? evalJson(item.attributes.accountItem, '$.listed_count') - item.attributes.yesterdayStats.listedCount : 0}","statusesCount":"@{evalJson(item.attributes.accountItem, '$.statuses_count')}","statusesCount_adds":"@{item.attributes.?yesterdayStats != null ? evalJson(item.attributes.accountItem, '$.statuses_count') - item.attributes.yesterdayStats.statusesCount : 0}","follows":"@{subtractLists(evalJson(item.attributes.todayIdsJson, '$[*].followerId'), evalJson(item.attributes.yesterdayIdsJson, '$[*].followerId')).?size()}","unfollows":"@{subtractLists(evalJson(item.attributes.yesterdayIdsJson, '$[*].followerId'), evalJson(item.attributes.todayIdsJson, '$[*].followerId')).?size()}"}},"outputs":[{"name":"success","destination":"save_account_stats","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"InsertMapIntoDB","name":"save_account_stats","properties":{"tableName":"AccountStats","fields":["accountId","extraction_date","favouritesCount","followersCount","friendsCount","listedCount","statusesCount","unfollows","follows","favouritesCount_adds","followersCount_adds","friendsCount_adds","listedCount_adds","statusesCount_adds"]},"outputs":[],"itemAttributes":{},"extendsStep":null},{"type":"DeleteFromDB","name":"clean_accounts","properties":{"tableName":"Accounts","predicates":[{"field":"id","operator":"=","value":"@{item.attributes.accountId}"}]},"outputs":[{"name":"success","destination":"map_current_account","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"ToMap","name":"map_current_account","properties":{"mappings":{"id":"@{evalJson(item, '$.id')}","name":"@{evalJson(item, '$.name')}","screenName":"@{evalJson(item, '$.screen_name')}","createdAt":"@{toDateTime(evalJson(item, '$.created_at'), 'E MMM dd HH:mm:ss Z yyyy')}","profileImageUrl":"@{evalJson(item, '$.profile_image_url')}"}},"outputs":[{"name":"success","destination":"save_account","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"InsertMapIntoDB","name":"save_account","properties":{"tableName":"Accounts","fields":["id","name","screenName","createdAt","profileImageUrl"]},"outputs":[],"itemAttributes":{},"extendsStep":null},{"type":"TwitterTimeline","name":"read_tweets_timeline","properties":{"resourceURL":"https://api.twitter.com/1.1/statuses/user_timeline.json","requestParams":{"user_id":"@{item.attributes.accountId}","count":"200","trim_user":true,"since_id":"@{item.attributes.maxId > 0 ? toLong(item.attributes.maxId) : null}","tweet_mode":"extended"}},"outputs":[{"name":"success","destination":"split_tweets","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"SplitJsonArray","name":"split_tweets","properties":{"propertyJsonArray":"@{evalJson(item, '$')}"},"outputs":[{"name":"success","destination":"tweet_to_map","condition":null}],"itemAttributes":null,"extendsStep":null},{"type":"ToMap","name":"tweet_to_map","properties":{"mappings":{"id":"@{evalJson(item, '$.id')}","retweet_id":"@{asString(evalJson(item, '$.retweeted_status.id'))}","reply_to_id":"@{asString(evalJson(item, '$.in_reply_to_status_id_str'))}","user_id":"@{asString(evalJson(item, '$.user.id'))}","text":"@{evalJson(item, '$.full_text')}","created_at":"@{toDateTime(evalJson(item, '$.created_at'), 'E MMM dd HH:mm:ss Z yyyy')}","NumericId":"@{evalJson(item, '$.id')}","type":"ORGANIC","origin":"@{evalJson(item, '$.in_reply_to_status_id_str') != null ? 'Reply' : (evalJson(item, '$.retweeted_status') != null ? 'Retweet' : 'Normal')}","normalAccountId":"@{item.attributes.accountId}"}},"outputs":[{"name":"success","destination":"save_tweets","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"InsertMapIntoDB","name":"save_tweets","properties":{"tableName":"OrganicTweets","batchSize":200,"fields":["id","created_at","text","retweet_id","reply_to_id","user_id","adgroup_id","tweet_status","updated_at","type","NumericId","origin","normalAccountId"]},"outputs":[],"itemAttributes":{},"extendsStep":null}],"excludes":[],"generalSteps":[],"dependencies":["twitter-store_followers"],"ignoreExceptionTypes":null,"exceptionIgnoreExpression":null},"extractor":{"id":0,"publicId":null,"lastExecution":null,"startExecution":null,"finishExecution":null,"queuedExecution":null,"nextExecution":null,"timeUnit":null,"timePeriod":0,"active":false,"status":null,"message":null,"errorCounter":0,"fullExtraction":true},"connectorCredentials":{"id":0,"organizationId":38,"datasourceId":1042812,"connectorType":"TWITTER","creationDate":null,"refreshToken":"1938593702-hjVY0RrhCvW2ceJbi8KUEEkp9Bgey47CO5IM9s5","datamart":"localhost","config":"{\"properties\":{\"reports\":[\"ACCOUNT_PERFORMANCE_REPORT_Normal\"],\"clientCustomerIds\":\"6241117324\"},\"to\":[],\"oauthAccessTokenSecret\":\"ctXQzxnH3bihSPCPVIuRfPQKtu03nXHiM7eyVzElSONAB\"}","extractor":null}}