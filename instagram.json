{"processDefinition":{"name":"instagram","steps":[{"type":"InsertMapIntoDB","name":"save_account","properties":{"tableName":"User","batchSize":200},"outputs":[],"itemAttributes":{},"extendsStep":null},{"type":"JsonToMap","name":"account_to_map","properties":{},"outputs":[{"name":"success","destination":"save_account","condition":null}],"itemAttributes":null,"extendsStep":null},{"type":"Instagram","name":"get_insta_account","properties":{"url":"@{item.content}","isSingleObject":true,"fields":["biography","id","ig_id","followers_count","follows_count","media_count","name","profile_picture_url","username","website"]},"outputs":[{"name":"success","destination":"account_to_map","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"SplitJsonArray","name":"split_insta_accounts","properties":{"propertyJsonArray":"@{evalJson(item, '$.data[*].instagram_business_account.id')}"},"outputs":[{"name":"success","destination":"get_insta_account","condition":null},{"name":"success","destination":"get_stories","condition":null},{"name":"success","destination":"clean_media","condition":null},{"name":"success","destination":"user_insights_interval","condition":null},{"name":"success","destination":"clean_demography","condition":null},{"name":"success","destination":"get_online_followers","condition":null}],"itemAttributes":{"accountId":"@{item.content}"},"extendsStep":null},{"type":"Instagram","name":"get_online_followers","properties":{"url":"@{item.attributes.accountId}/insights","isSingleObject":true,"parameters":{"metric":"online_followers","period":"lifetime","since":"@{epoch(now().minusDays(25)) / 1000}","until":"@{epoch(now()) / 1000}"}},"outputs":[{"name":"success","destination":"clean_online_followers","condition":null}],"itemAttributes":{"lastDay":"@{toDateTime(last(evalJson(item, '$..values[?(@.value.0)].end_time')),'yyyy-MM-dd\\'T\\'HH:mm:ssZ')}"},"extendsStep":null},{"type":"SplitJsonArray","name":"split_online_followers","properties":{"array":"@{evalJson(item, '$.data[*].values[*]')}"},"outputs":[{"name":"success","destination":"split_online_follower_hours","condition":null}],"itemAttributes":{"end_time":"@{toDateTime(evalJson(item, '$.end_time'), 'yyyy-MM-dd\\'T\\'HH:mm:ssZ')}"},"extendsStep":null},{"type":"SplitJsonByProperty","name":"split_online_follower_hours","properties":{"property":"value"},"outputs":[{"name":"success","destination":"map_online_followers","condition":null}],"itemAttributes":{"exact_time":"@{item.attributes.end_time.plusHours(toInt(evalJson(item, '$.value_key')))}"},"extendsStep":null},{"type":"ToMap","name":"map_online_followers","properties":{"mappings":{"end_time":"@{item.attributes.exact_time}","hour":"@{item.attributes.exact_time.getHour()}","value":"@{evalJson(item, '$.value_value')}","userId":"@{item.attributes.accountId}"}},"outputs":[{"name":"success","destination":"save_online_followers","condition":"@{item.attributes.?lastDay == null || (!item.attributes.exact_time.isAfter(item.attributes.lastDay.plusDays(1).toLocalDate().atStartOfDay().minusMinutes(1)) && item.attributes.exact_time.isAfter(item.attributes.lastDay.minusDays(6).toLocalDate().atStartOfDay().minusMinutes(1)))}"}],"itemAttributes":{},"extendsStep":null},{"type":"InsertMapIntoDB","name":"save_online_followers","properties":{"tableName":"OnlineFollowersInsight","batchSize":400,"fields":["userId","hour","value","end_time"]},"outputs":[],"itemAttributes":{},"extendsStep":null},{"type":"DeleteFromDB","name":"clean_demography","properties":{"tables":["AudienceLocale","AudienceCity","AudienceCountry","AudienceGenderAge"],"predicates":[{"field":"userId","value":"@{item.attributes.accountId}"}]},"outputs":[{"name":"success","destination":"get_user_demography","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"GetIntervals","name":"user_insights_interval","properties":{"totalMonths":"@{config.totalMonths}","batchDays":"@{config.batchDays}","daysToExtract":"@{config.daysToExtract}"},"outputs":[{"name":"success","destination":"clean_user_insights","condition":null}],"itemAttributes":{"ownerId":"@{evalJson(item, '$.owner.id')}","parentId":"@{evalJson(item, '$.id')}"},"extendsStep":null},{"type":"DeleteFromDB","name":"clean_user_insights","properties":{"tables":["UserInsight"],"predicates":[{"field":"end_time","operator":">=","value":"@{item.content.from}"},{"field":"end_time","operator":"<","value":"@{item.content.until}"},{"field":"userId","value":"@{item.attributes.accountId}"}]},"outputs":[{"name":"success","destination":"get_user_insights","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"DeleteFromDB","name":"clean_online_followers","properties":{"tables":["OnlineFollowersInsight"],"predicates":[{"field":"userId","value":"@{item.attributes.accountId}"}]},"outputs":[{"name":"success","destination":"split_online_followers","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"Instagram","name":"get_user_demography","properties":{"url":"@{item.attributes.accountId}/insights","isSingleObject":true,"parameters":{"metric":"audience_city,audience_country,audience_gender_age,audience_locale,online_followers","period":"lifetime"}},"outputs":[{"name":"success","destination":"split_age_range","condition":null},{"name":"success","destination":"split_city","condition":null},{"name":"success","destination":"split_country","condition":null},{"name":"success","destination":"split_audience_locale","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"SplitJsonArray","name":"split_audience_locale","properties":{"array":"@{evalJson(item, '$.data[?(@.name == \\'audience_locale\\')].values[0].value')}"},"outputs":[{"name":"success","destination":"split_locale_keys","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"SplitJsonByProperty","name":"split_locale_keys","properties":{},"outputs":[{"name":"success","destination":"map_audience_locale","condition":null}],"itemAttributes":null,"extendsStep":null},{"type":"ToMap","name":"map_audience_locale","properties":{"mappings":{"locale":"@{evalJson(item, '$.object_key')}","audience":"@{evalJson(item, '$.object_value')}","userId":"@{item.attributes.accountId}"}},"outputs":[{"name":"success","destination":"save_audience_loacle","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"InsertMapIntoDB","name":"save_audience_loacle","properties":{"tableName":"AudienceLocale","fields":["locale","audience","userId"]},"outputs":[],"itemAttributes":{},"extendsStep":null},{"type":"SplitJsonArray","name":"split_country","properties":{"array":"@{evalJson(item, '$.data[?(@.name == \\'audience_country\\')].values[0].value')}"},"outputs":[{"name":"success","destination":"split_country_key","condition":null}],"itemAttributes":{"countryMap":"@{['AF':'Afghanistan','AX':'Aland Islands','AL':'Albania','DZ':'Algeria','AS':'American Samoa','AD':'Andorra','AO':'Angola','AI':'Anguilla','AQ':'Antarctica','AG':'Antigua and Barbuda','AR':'Argentina','AM':'Armenia','AW':'Aruba','AU':'Australia','AT':'Austria','AZ':'Azerbaijan','BS':'Bahamas','BH':'Bahrain','BD':'Bangladesh','BB':'Barbados','BY':'Belarus','BE':'Belgium','BZ':'Belize','BJ':'Benin','BM':'Bermuda','BT':'Bhutan','BO':'Bolivia','BA':'Bosnia and Herzegovina','BW':'Botswana','BV':'Bouvet Island','BR':'Brazil','VG':'British Virgin Islands','IO':'British Indian Ocean Territory','BN':'Brunei Darussalam','BG':'Bulgaria','BF':'Burkina Faso','BI':'Burundi','KH':'Cambodia','CM':'Cameroon','CA':'Canada','CV':'Cape Verde','KY':'Cayman Islands','CF':'Central African Republic','TD':'Chad','CL':'Chile','CN':'China','HK':'Hong Kong, SAR China','MO':'Macao, SAR China','CX':'Christmas Island','CC':'Cocos (Keeling) Islands','CO':'Colombia','KM':'Comoros','CG':'Congo (Brazzaville)','CD':'Congo, (Kinshasa)','CK':'Cook Islands','CR':'Costa Rica','CI':'Côte d`Ivoire','HR':'Croatia','CU':'Cuba','CY':'Cyprus','CZ':'Czech Republic','DK':'Denmark','DJ':'Djibouti','DM':'Dominica','DO':'Dominican Republic','EC':'Ecuador','EG':'Egypt','SV':'El Salvador','GQ':'Equatorial Guinea','ER':'Eritrea','EE':'Estonia','ET':'Ethiopia','FK':'Falkland Islands (Malvinas)','FO':'Faroe Islands','FJ':'Fiji','FI':'Finland','FR':'France','GF':'French Guiana','PF':'French Polynesia','TF':'French Southern Territories','GA':'Gabon','GM':'Gambia','GE':'Georgia','DE':'Germany','GH':'Ghana','GI':'Gibraltar','GR':'Greece','GL':'Greenland','GD':'Grenada','GP':'Guadeloupe','GU':'Guam','GT':'Guatemala','GG':'Guernsey','GN':'Guinea','GW':'Guinea-Bissau','GY':'Guyana','HT':'Haiti','HM':'Heard and Mcdonald Islands','VA':'Holy See (Vatican City State)','HN':'Honduras','HU':'Hungary','IS':'Iceland','IN':'India','ID':'Indonesia','IR':'Iran, Islamic Republic of','IQ':'Iraq','IE':'Ireland','IM':'Isle of Man','IL':'Israel','IT':'Italy','JM':'Jamaica','JP':'Japan','JE':'Jersey','JO':'Jordan','KZ':'Kazakhstan','KE':'Kenya','KI':'Kiribati','KP':'Korea (North)','KR':'Korea (South)','KW':'Kuwait','KG':'Kyrgyzstan','LA':'Lao PDR','LV':'Latvia','LB':'Lebanon','LS':'Lesotho','LR':'Liberia','LY':'Libya','LI':'Liechtenstein','LT':'Lithuania','LU':'Luxembourg','MK':'Macedonia, Republic of','MG':'Madagascar','MW':'Malawi','MY':'Malaysia','MV':'Maldives','ML':'Mali','MT':'Malta','MH':'Marshall Islands','MQ':'Martinique','MR':'Mauritania','MU':'Mauritius','YT':'Mayotte','MX':'Mexico','FM':'Micronesia, Federated States of','MD':'Moldova','MC':'Monaco','MN':'Mongolia','ME':'Montenegro','MS':'Montserrat','MA':'Morocco','MZ':'Mozambique','MM':'Myanmar','NA':'Namibia','NR':'Nauru','NP':'Nepal','NL':'Netherlands','AN':'Netherlands Antilles','NC':'New Caledonia','NZ':'New Zealand','NI':'Nicaragua','NE':'Niger','NG':'Nigeria','NU':'Niue','NF':'Norfolk Island','MP':'Northern Mariana Islands','NO':'Norway','OM':'Oman','PK':'Pakistan','PW':'Palau','PS':'Palestinian Territory','PA':'Panama','PG':'Papua New Guinea','PY':'Paraguay','PE':'Peru','PH':'Philippines','PN':'Pitcairn','PL':'Poland','PT':'Portugal','PR':'Puerto Rico','QA':'Qatar','RE':'Réunion','RO':'Romania','RU':'Russian Federation','RW':'Rwanda','BL':'Saint-Barthélemy','SH':'Saint Helena','KN':'Saint Kitts and Nevis','LC':'Saint Lucia','MF':'Saint-Martin (French part)','PM':'Saint Pierre and Miquelon','VC':'Saint Vincent and Grenadines','WS':'Samoa','SM':'San Marino','ST':'Sao Tome and Principe','SA':'Saudi Arabia','SN':'Senegal','RS':'Serbia','SC':'Seychelles','SL':'Sierra Leone','SG':'Singapore','SK':'Slovakia','SI':'Slovenia','SB':'Solomon Islands','SO':'Somalia','ZA':'South Africa','GS':'South Georgia and the South Sandwich Islands','SS':'South Sudan','ES':'Spain','LK':'Sri Lanka','SD':'Sudan','SR':'Suriname','SJ':'Svalbard and Jan Mayen Islands','SZ':'Swaziland','SE':'Sweden','CH':'Switzerland','SY':'Syrian Arab Republic (Syria)','TW':'Taiwan, Republic of China','TJ':'Tajikistan','TZ':'Tanzania, United Republic of','TH':'Thailand','TL':'Timor-Leste','TG':'Togo','TK':'Tokelau','TO':'Tonga','TT':'Trinidad and Tobago','TN':'Tunisia','TR':'Turkey','TM':'Turkmenistan','TC':'Turks and Caicos Islands','TV':'Tuvalu','UG':'Uganda','UA':'Ukraine','AE':'United Arab Emirates','GB':'United Kingdom','US':'United States of America','UM':'US Minor Outlying Islands','UY':'Uruguay','UZ':'Uzbekistan','VU':'Vanuatu','VE':'Venezuela (Bolivarian Republic)','VN':'Viet Nam','VI':'Virgin Islands, US','WF':'Wallis and Futuna Islands','EH':'Western Sahara','YE':'Yemen','ZM':'Zambia','ZW':'Zimbabwe', 'OO': 'Other']}"},"extendsStep":null},{"type":"SplitJsonByProperty","name":"split_country_key","properties":{},"outputs":[{"name":"success","destination":"map_audience_country","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"ToMap","name":"map_audience_country","properties":{"mappings":{"country":"@{item.attributes.countryMap.get(evalJson(item, '$.object_key'))}","audience":"@{evalJson(item, '$.object_value')}","userId":"@{item.attributes.accountId}"}},"outputs":[{"name":"success","destination":"save_audience_country","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"InsertMapIntoDB","name":"save_audience_country","properties":{"tableName":"AudienceCountry","fields":["country","audience","userId"]},"outputs":[],"itemAttributes":{},"extendsStep":null},{"type":"SplitJsonArray","name":"split_city","properties":{"array":"@{evalJson(item, '$.data[?(@.name == \\'audience_city\\')].values[0].value')}"},"outputs":[{"name":"success","destination":"split_city_keys","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"SplitJsonByProperty","name":"split_city_keys","properties":{},"outputs":[{"name":"success","destination":"map_city","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"ToMap","name":"map_city","properties":{"mappings":{"city":"@{evalJson(item, '$.object_key')}","audience":"@{evalJson(item, '$.object_value')}","userId":"@{item.attributes.accountId}"}},"outputs":[{"name":"success","destination":"save_audience_city","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"InsertMapIntoDB","name":"save_audience_city","properties":{"tableName":"AudienceCity","fields":["city","audience","userId"]},"outputs":[],"itemAttributes":{},"extendsStep":null},{"type":"SplitJsonArray","name":"split_age_range","properties":{"array":"@{evalJson(item, '$.data[?(@.name == \\'audience_gender_age\\')].values[0].value')}"},"outputs":[{"name":"success","destination":"split_gender_age_keys","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"SplitJsonByProperty","name":"split_gender_age_keys","properties":{},"outputs":[{"name":"success","destination":"map_age_gender","condition":null}],"itemAttributes":{"gender":"@{evalJson(item, '$.object_key').substring(0,1)}"},"extendsStep":null},{"type":"ToMap","name":"map_age_gender","properties":{"mappings":{"gender":"@{item.attributes.gender == 'M' ? 'MALE' : (item.attributes.gender == 'F' ? 'FEMALE' : 'UNKNOWN')}","ageRange":"@{evalJson(item, '$.object_key').substring(2)}","audience":"@{evalJson(item, '$.object_value')}","userId":"@{item.attributes.accountId}"}},"outputs":[{"name":"success","destination":"save_age_range","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"InsertMapIntoDB","name":"save_age_range","properties":{"tableName":"AudienceGenderAge","fields":["userId","ageRange","gender","audience"]},"outputs":[],"itemAttributes":{},"extendsStep":null},{"type":"Instagram","name":"get_user_insights","properties":{"url":"@{item.attributes.accountId}/insights","isSingleObject":true,"parameters":{"metric":"impressions,reach,follower_count,email_contacts,phone_call_clicks,text_message_clicks,get_directions_clicks,website_clicks,profile_views","period":"day","since":"@{epoch(item.content.from) / 1000}","until":"@{epoch(item.content.until) / 1000}"}},"outputs":[{"name":"success","destination":"merge_user_insights","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"MergeJsonArrays","name":"merge_user_insights","properties":{"arrays":{"impressions":"@{evalJson(item , '$.data[?(@.name==\\'impressions\\')].values[*]')}","reach":"@{evalJson(item , '$.data[?(@.name==\\'reach\\')].values[*]')}","follower_count":"@{evalJson(item , '$.data[?(@.name==\\'follower_count\\')].values[*]')}","email_contacts":"@{evalJson(item , '$.data[?(@.name==\\'email_contacts\\')].values[*]')}","phone_call_clicks":"@{evalJson(item , '$.data[?(@.name==\\'phone_call_clicks\\')].values[*]')}","text_message_clicks":"@{evalJson(item , '$.data[?(@.name==\\'text_message_clicks\\')].values[*]')}","get_directions_clicks":"@{evalJson(item , '$.data[?(@.name==\\'get_directions_clicks\\')].values[*]')}","website_clicks":"@{evalJson(item , '$.data[?(@.name==\\'website_clicks\\')].values[*]')}","profile_views":"@{evalJson(item , '$.data[?(@.name==\\'profile_views\\')].values[*]')}"},"additionalJsonProperties":{},"split":true},"outputs":[{"name":"success","destination":"change_user_insights","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"ToMap","name":"change_user_insights","properties":{"mappings":{"impressions":"@{evalJson(item, '$.impressions.value')}","reach":"@{evalJson(item, '$.reach.value')}","follower_count":"@{evalJson(item, '$.follower_count.value')}","email_contacts":"@{evalJson(item, '$.email_contacts.value')}","phone_call_clicks":"@{evalJson(item, '$.phone_call_clicks.value')}","text_message_clicks":"@{evalJson(item, '$.text_message_clicks.value')}","get_directions_clicks":"@{evalJson(item, '$.get_directions_clicks.value')}","website_clicks":"@{evalJson(item, '$.website_clicks.value')}","profile_views":"@{evalJson(item, '$.profile_views.value')}","end_time":"@{toDateTime(evalJson(item, '$.impressions.end_time'), 'yyyy-MM-dd\\'T\\'HH:mm:ssZ')}","userId":"@{item.attributes.accountId}"}},"outputs":[{"name":"success","destination":"save_user_insights","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"InsertMapIntoDB","name":"save_user_insights","properties":{"tableName":"UserInsight","batchSize":200},"outputs":[],"itemAttributes":{},"extendsStep":null},{"type":"DeleteFromDB","name":"clean_media","properties":{"tableName":"Media","predicates":[{"field":"is_story","value":"@{false}","operator":"="},{"field":"ownerId","value":"@{item.attributes.accountId}","operator":"="}]},"outputs":[{"name":"success","destination":"clean_media_insight","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"DeleteFromDB","name":"clean_media_insight","properties":{"tableName":"MediaInsight","predicates":[{"field":"extraction_date","operator":">=","value":"@{currentDate().atStartOfDay()}"}]},"outputs":[{"name":"success","destination":"get_media","condition":null},{"name":"success","destination":"get_carousels","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"Instagram","name":"get_media","properties":{"url":"@{item.attributes.accountId}/media","isSingleObject":false,"fields":["caption","timestamp","comments_count","id","ig_id","is_comment_enabled","like_count","media_type","media_url","owner","permalink","shortcode","thumbnail_url","insights.metric(engagement,reach,impressions,saved,carousel_album_saved).period(lifetime)","comments{hidden,id,like_count,media,text,timestamp,user,replies}","children{id,ig_id,media_type,media_url,permalink,shortcode,timestamp}"]},"outputs":[{"name":"success","destination":"split_carousel_children","condition":null},{"name":"success","destination":"split_media_comments","condition":null},{"name":"success","destination":"map_media_insights","condition":null},{"name":"success","destination":"map_media","condition":null}],"itemAttributes":{"ownerId":"@{evalJson(item, '$.owner.id')}","parentId":"@{evalJson(item, '$.id')}"},"extendsStep":null},{"type":"Instagram","name":"get_carousels","properties":{"url":"@{item.attributes.accountId}/media","isSingleObject":true,"fields":["caption","timestamp","comments_count","id","ig_id","is_comment_enabled","like_count","media_type","media_url","owner","permalink","shortcode","thumbnail_url","children{id,ig_id,media_type,media_url,permalink,shortcode,timestamp}","insights.metric(carousel_album_engagement,carousel_album_reach,carousel_album_video_views,carousel_album_impressions,carousel_album_saved,engagement,reach,impressions).period(lifetime)"]},"outputs":[{"name":"success","destination":"split_carousel","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"SplitJsonArray","name":"split_carousel","properties":{"propertyJsonArray":"@{evalJson(item, '$.data')}"},"outputs":[{"name":"success","destination":"map_carousel_insights","condition":null}],"itemAttributes":{"ownerId":"@{evalJson(item, '$.owner.id')}","parentId":"@{evalJson(item, '$.id')}"},"extendsStep":null},{"type":"ToMap","name":"map_carousel_insights","properties":{"mappings":{"engagement":"@{?evalJson(item, '$.insights.data[?(@.name==\\'engagement\\')].values[0].value').get(0)}","reach":"@{?evalJson(item, '$.insights.data[?(@.name==\\'reach\\')].values[0].value').get(0)}","impressions":"@{?evalJson(item, '$.insights.data[?(@.name==\\'impressions\\')].values[0].value').get(0)}","saved":"@{?evalJson(item, '$.insights.data[?(@.name==\\'saved\\')].values[0].value').get(0)}","carousel_album_impressions":"@{?evalJson(item, '$.insights.data[?(@.name==\\'carousel_album_impressions\\')].values[0].value').get(0)}","carousel_album_video_views":"@{?evalJson(item, '$.insights.data[?(@.name==\\'video_views\\')].values[0].value').get(0)}","carousel_album_reach":"@{?evalJson(item, '$.insights.data[?(@.name==\\'carousel_album_reach\\')].values[0].value').get(0)}","carousel_album_engagement":"@{?evalJson(item, '$.insights.data[?(@.name==\\'carousel_album_engagement\\')].values[0].value').get(0)}","timestamp":"@{now()}","mediaId":"@{evalJson(item, '$.id')}"}},"outputs":[{"name":"success","destination":"save_mdeia_insights","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"SplitJsonArray","name":"split_carousel_children","properties":{"propertyJsonArray":"@{evalJson(item, '$.children.data')}"},"outputs":[{"name":"success","destination":"map_carousel_children","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"JsonToMap","name":"map_carousel_children","properties":{"mappings":{"timestamp":"@{toDateTime(evalJson(item, '$.timestamp'), 'yyyy-MM-dd\\'T\\'HH:mm:ssZ')}","is_story":"@{false}","ownerId":"@{item.attributes.ownerId}","parentId":"@{item.attributes.parentId}"}},"outputs":[{"name":"success","destination":"save_carousel_children","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"InsertMapIntoDB","name":"save_carousel_children","properties":{"tableName":"Media","batchSize":200},"outputs":[],"itemAttributes":{},"extendsStep":null},{"type":"SplitJsonArray","name":"split_media_comments","properties":{"propertyJsonArray":"@{evalJson(item, '$.comments.data')}"},"outputs":[{"name":"success","destination":"map_comments","condition":null},{"name":"success","destination":"split_comment_replies","condition":null}],"itemAttributes":{"mediaId":"@{evalJson(item, '$.media.id')}","userId":"@{evalJson(item, '$.user.id')}","parentCommentId":"@{evalJson(item, '$.id')}"},"extendsStep":null},{"type":"JsonToMap","name":"map_comments","properties":{"mappings":{"mediaId":"@{evalJson(item, '$.media.id')}","userId":"@{evalJson(item, '$.user.id')}","timestamp":"@{toDateTime(evalJson(item, '$.timestamp'), 'yyyy-MM-dd\\'T\\'HH:mm:ssZ')}"},"excludes":["media","user"]},"outputs":[{"name":"success","destination":"save_comments","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"SplitJsonArray","name":"split_comment_replies","properties":{"propertyJsonArray":"@{evalJson(item, '$.replies.data[*]')}"},"outputs":[{"name":"success","destination":"map_replies","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"ToMap","name":"map_replies","properties":{"mappings":{"mediaId":"@{item.attributes.mediaId}","text":"@{evalJson(item, '$.text')}","id":"@{evalJson(item, '$.id')}","timestamp":"@{toDateTime(evalJson(item, '$.timestamp'), 'yyyy-MM-dd\\'T\\'HH:mm:ssZ')}","parentId":"@{item.attributes.parentCommentId}"}},"outputs":[{"name":"success","destination":"save_comments","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"InsertMapIntoDB","name":"save_comments","properties":{"tableName":"Comment","batchSize":200,"fields":["id","parentId","mediaId","text","timestamp","userId","like_count","hidden"]},"outputs":[],"itemAttributes":{},"extendsStep":null},{"type":"JsonToMap","name":"map_media_insights","properties":{"mappings":{"engagement":"@{?evalJson(item, '$.insights.data[?(@.name==\\'engagement\\')].values[0].value').get(0)}","reach":"@{?evalJson(item, '$.insights.data[?(@.name==\\'reach\\')].values[0].value').get(0)}","impressions":"@{?evalJson(item, '$.insights.data[?(@.name==\\'impressions\\')].values[0].value').get(0)}","saved":"@{?evalJson(item, '$.insights.data[?(@.name==\\'saved\\')].values[0].value').get(0)}","extraction_date":"@{now()}","mediaId":"@{evalJson(item, '$.id')}"},"excludes":["ig_id","children","shortcode","media_url","is_comment_enabled","media_type","id","permalink","owner","insights","comments","caption"]},"outputs":[{"name":"success","destination":"save_mdeia_insights","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"InsertMapIntoDB","name":"save_mdeia_insights","properties":{"tableName":"MediaInsight","batchSize":200,"fields":["mediaId","extraction_date","engagement","impressions","reach","saved","comments_count","like_count"]},"outputs":[],"itemAttributes":{},"extendsStep":null},{"type":"JsonToMap","name":"map_media","properties":{"mappings":{"timestamp":"@{toDateTime(evalJson(item, '$.timestamp'), 'yyyy-MM-dd\\'T\\'HH:mm:ssZ')}","is_story":"@{false}","ownerId":"@{evalJson(item, '$.owner.id')}"},"excludes":["comments","children","owner","insights","children"]},"outputs":[{"name":"success","destination":"save_media","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"InsertMapIntoDB","name":"save_media","properties":{"tableName":"Media","batchSize":200,"fields":["id","parentId","caption","timestamp","is_comment_enabled","media_type","ownerId","media_url","is_story","ig_id","permalink","shortcode","thumbnail_url"]},"outputs":[],"itemAttributes":{},"extendsStep":null},{"type":"Instagram","name":"get_stories","properties":{"url":"@{item.attributes.accountId}/stories","isSingleObject":true,"fields":["caption","timestamp","id","ig_id","media_type","media_url","owner","permalink","shortcode","thumbnail_url","insights.metric(exits,impressions,reach,replies,taps_forward,taps_back).period(lifetime)"]},"outputs":[{"name":"success","destination":"split_stories","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"SplitJsonArray","name":"split_stories","properties":{"propertyJsonArray":"@{evalJson(item, '$.data')}"},"outputs":[{"name":"success","destination":"clean_stories","condition":null},{"name":"success","destination":"clean_story_insights","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"DeleteFromDB","name":"clean_story_insights","properties":{"tableName":"StoryInsight","predicates":[{"field":"storyId","operator":"=","value":"@{evalJson(item, '$.id')}"},{"field":"extraction_date","operator":">=","value":"@{currentDate().atStartOfDay()}"}]},"outputs":[{"name":"success","destination":"map_story_insights","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"DeleteFromDB","name":"clean_stories","properties":{"tableName":"Media","predicates":[{"field":"id","operator":"=","value":"@{evalJson(item, '$.id')}"}]},"outputs":[{"name":"success","destination":"map_stories","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"JsonToMap","name":"map_story_insights","properties":{"excludes":["ig_id","shortcode","media_url","is_comment_enabled","media_type","comments_count","id","permalink","owner","like_count","insights"],"mappings":{"storyId":"@{evalJson(item, '$.id')}","exits":"@{?evalJson(item, '$.insights.data[?(@.name==\\'exits\\')].values[0].value').get(0)}","impressions":"@{?evalJson(item, '$.insights.data[?(@.name==\\'impressions\\')].values[0].value').get(0)}","reach":"@{?evalJson(item, '$.insights.data[?(@.name==\\'reach\\')].values[0].value').get(0)}","replies":"@{?evalJson(item, '$.insights.data[?(@.name==\\'replies\\')].values[0].value').get(0)}","taps_forward":"@{?evalJson(item, '$.insights.data[?(@.name==\\'taps_forward\\')].values[0].value').get(0)}","taps_back":"@{?evalJson(item, '$.insights.data[?(@.name==\\'taps_back\\')].values[0].value').get(0)}","extraction_date":"@{now()}"}},"outputs":[{"name":"success","destination":"change_story_insights","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"Modify","name":"change_story_insights","properties":{"value":{"extraction_date":"@{item.content.extraction_date}","storyId":"@{item.content.storyId}","exits":"@{item.content.exits >= 0 ? item.content.exits : 0}","replies":"@{item.content.replies >= 0 ? item.content.replies : 0}","reach":"@{item.content.reach >= 0 ? item.content.reach : 0}","impressions":"@{item.content.impressions >= 0 ? item.content.impressions : 0}","taps_back":"@{item.content.taps_back >= 0 ? item.content.taps_back : 0}","taps_forward":"@{item.content.taps_forward >= 0 ? item.content.taps_forward : 0}"}},"outputs":[{"name":"success","destination":"save_story_insights","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"InsertMapIntoDB","name":"save_story_insights","properties":{"tableName":"StoryInsight","batchSize":200},"outputs":[],"itemAttributes":{},"extendsStep":null},{"type":"JsonToMap","name":"map_stories","properties":{"mappings":{"ownerId":"@{evalJson(item, '$.owner.id')}","is_story":"@{true}","timestamp":"@{toDateTime(evalJson(item, '$.timestamp'), 'yyyy-MM-dd\\'T\\'HH:mm:ssZ')}"},"excludes":["insights","owner"]},"outputs":[{"name":"success","destination":"save_stories","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"InsertMapIntoDB","name":"save_stories","properties":{"tableName":"Media","batchSize":200,"fields":["id","parentId","caption","timestamp","is_comment_enabled","media_type","ownerId","media_url","is_story","ig_id","permalink","shortcode","thumbnail_url"]},"outputs":[],"itemAttributes":{},"extendsStep":null},{"type":"DeleteFromDB","name":"delete_accounts_and_comments","properties":{"tables":["User","Comment"]},"outputs":[{"name":"success","destination":"split_insta_accounts","condition":null}],"itemAttributes":{},"extendsStep":null},{"type":"Instagram","name":"get_fb_account","properties":{"url":"me/accounts","isSingleObject":true,"fields":["instagram_business_account"]},"outputs":[{"name":"success","destination":"delete_accounts_and_comments","condition":null}],"itemAttributes":{},"extendsStep":null}],"excludes":["get_carousels","split_carousel_children","get_insta_account","get_online_followers","clean_demography","get_stories","user_insights_interval"],"generalSteps":[{"type":"GetIntervals","name":"analytic_intervals","properties":{"totalMonths":3,"batchDays":90,"daysToExtract":3},"outputs":null,"itemAttributes":{"from":"@{item.content.from}","until":"@{item.content.until}"},"extendsStep":null}],"dependencies":null,"ignoreExceptionTypes":null,"exceptionIgnoreExpression":null},"extractor":{"id":0,"publicId":null,"lastExecution":null,"startExecution":null,"finishExecution":null,"queuedExecution":null,"nextExecution":null,"timeUnit":null,"timePeriod":0,"active":false,"status":null,"errorType":null,"message":null,"errorCounter":0,"fullExtraction":true},"connectorCredentials":{"id":0,"organizationId":35,"datasourceId":1046410,"connectorType":"INSTAGRAM_BUSINESS","creationDate":null,"refreshToken":"EAAGuoVILSX4BAN6ckZCSSc3payZBZCJYAOCKUMrX16R1EjGzklcrjvyU1GJGcVydN9h4rlq91IZAd6wffMyH4pQ6fdrkSPWnif1e7ZCMKZAJPtgZAgV1ZBG3HjKsCWYzZCvrQaBWdmbPkAyAMJhMf8jYsenwy5ZCZCG5ENtUlGHaX67SHLmP6zZANS27jkAV55V5HEgZD","datamart":"localhost","config":"{\"properties\":{\"pageId\":\"100230508074773910534\",\"domain\":\"mettrr\",\"customFields\":[{\"id\":360001124611,\"title\":\"3rd Line Tech Support (UK) Type of Change/Request\"},{\"id\":360001486852,\"title\":\"3rd Line Adwords management Type of Change/Request\"},{\"id\":360001486872,\"title\":\"3rd Line Product support Type of Change/Request\"},{\"id\":360001063512,\"title\":\"2nd Line Legacy CWT Type of Change/Request\"},{\"id\":360002165852,\"title\":\"Mark as Spam\"},{\"id\":360001063532,\"title\":\"3rd Line Accounts and Admin (UK) Type of Change/Request\"},{\"id\":360001062512,\"title\":\"2nd Line CWT Type of Change/Request\"},{\"id\":360001123991,\"title\":\"1st Line Type of Change/Request\"},{\"id\":360001124771,\"title\":\"3rd Line Content (UK) Type of Change/Request\"},{\"id\":360001227172,\"title\":\"Country\"},{\"id\":360001124011,\"title\":\"2nd Line CTT Type of Change/Request\"},{\"id\":360001227992,\"title\":\"Phone Number - Only from form submission\"}],\"clientCustomerIds\":[\"8670301477\"],\"reports\":[\"PLACEHOLDER_REPORT_Normal\",\"PLACEMENT_PERFORMANCE_REPORT_Normal\",\"PRODUCT_PARTITION_REPORT_Normal\",\"SEARCH_QUERY_PERFORMANCE_REPORT_Normal\",\"SHOPPING_PERFORMANCE_REPORT_ConversionSegmented\",\"SHOPPING_PERFORMANCE_REPORT_Normal\",\"TOP_CONTENT_PERFORMANCE_REPORT_Normal\",\"URL_PERFORMANCE_REPORT_ConversionSegmented\",\"URL_PERFORMANCE_REPORT_Normal\",\"USER_AD_DISTANCE_REPORT_Normal\",\"VIDEO_PERFORMANCE_REPORT_ConversionSegmented\",\"VIDEO_PERFORMANCE_REPORT_Normal\"]},\"to\":[],\"oauthAccessTokenSecret\":\"oLZCb0LjGWAmmTONV8ciiz9f6ng488dncQps2h1eo2s2D\"}","extractor":null}}