{"processDefinition":{"name":"instagram","steps":[{"type":"InsertMapIntoDB","name":"save_account","properties":{"tableName":"User","batchSize":200},"outputs":[],"itemAttributes":{},"x":1350,"y":0},{"type":"JsonToMap","name":"account_to_map","properties":{},"outputs":[{"name":"success","destination":"save_account"}],"x":1080,"y":0},{"type":"FacebookGraph","name":"get_insta_account","properties":{"url":"@{item.content}","isSingleObject":true,"fields":["biography","id","ig_id","followers_count","follows_count","media_count","name","profile_picture_url","username","website"]},"outputs":[{"name":"success","destination":"account_to_map"}],"itemAttributes":{},"x":810,"y":0},{"type":"SplitJsonArray","name":"split_insta_accounts","properties":{"propertyJsonArray":"@{evalJson(item, '$.data[*].instagram_business_account.id')}"},"outputs":[{"name":"success","destination":"get_insta_account"},{"name":"success","destination":"get_stories"},{"name":"success","destination":"clean_media"},{"name":"success","destination":"user_insights_interval"}],"itemAttributes":{"accountId":"@{item.content}"},"x":540,"y":0},{"type":"GetIntervals","name":"user_insights_interval","properties":{"totalMonths":10,"batchDays":29,"daysToExtract":3},"outputs":[{"name":"success","destination":"clean_user_insights"}],"itemAttributes":{"ownerId":"@{evalJson(item, '$.owner.id')}","parentId":"@{evalJson(item, '$.id')}"},"x":810,"y":120},{"type":"DeleteFromDB","name":"clean_user_insights","properties":{"tableName":"UserInsight","predicates":[{"field":"end_time","operator":">=","value":"@{item.content.from}"},{"field":"end_time","operator":"<","value":"@{item.content.until}"}]},"outputs":[{"name":"success","destination":"get_user_insights"}],"itemAttributes":{},"x":1080,"y":120},{"type":"FacebookGraph","name":"get_user_insights","properties":{"url":"@{item.attributes.accountId}/insights","isSingleObject":true,"parameters":{"metric":"impressions,reach,follower_count,email_contacts,phone_call_clicks,text_message_clicks,get_directions_clicks,website_clicks,profile_views","period":"day","since":"@{epoch(item.content.from) / 1000}","until":"@{epoch(item.content.until) / 1000}"}},"outputs":[{"name":"success","destination":"merge_user_insights"}],"itemAttributes":{},"x":1350,"y":120},{"type":"MergeJsonArrays","name":"merge_user_insights","properties":{"arrays":{"impressions":"@{evalJson(item , '$.data[?(@.name==\\'impressions\\')].values[*]')}","reach":"@{evalJson(item , '$.data[?(@.name==\\'reach\\')].values[*]')}","follower_count":"@{evalJson(item , '$.data[?(@.name==\\'follower_count\\')].values[*]')}","email_contacts":"@{evalJson(item , '$.data[?(@.name==\\'email_contacts\\')].values[*]')}","phone_call_clicks":"@{evalJson(item , '$.data[?(@.name==\\'phone_call_clicks\\')].values[*]')}","text_message_clicks":"@{evalJson(item , '$.data[?(@.name==\\'text_message_clicks\\')].values[*]')}","get_directions_clicks":"@{evalJson(item , '$.data[?(@.name==\\'get_directions_clicks\\')].values[*]')}","website_clicks":"@{evalJson(item , '$.data[?(@.name==\\'website_clicks\\')].values[*]')}","profile_views":"@{evalJson(item , '$.data[?(@.name==\\'profile_views\\')].values[*]')}"},"additionalJsonProperties":{},"split":true},"outputs":[{"name":"success","destination":"change_user_insights"}],"itemAttributes":{},"x":1620,"y":120},{"type":"ToMap","name":"change_user_insights","properties":{"mappings":{"impressions":"@{evalJson(item, '$.impressions.value')}","reach":"@{evalJson(item, '$.reach.value')}","follower_count":"@{evalJson(item, '$.follower_count.value')}","email_contacts":"@{evalJson(item, '$.email_contacts.value')}","phone_call_clicks":"@{evalJson(item, '$.phone_call_clicks.value')}","text_message_clicks":"@{evalJson(item, '$.text_message_clicks.value')}","get_directions_clicks":"@{evalJson(item, '$.get_directions_clicks.value')}","website_clicks":"@{evalJson(item, '$.website_clicks.value')}","profile_views":"@{evalJson(item, '$.profile_views.value')}","end_time":"@{toDateTime(evalJson(item, '$.impressions.end_time'), 'yyyy-MM-dd\\'T\\'HH:mm:ssZ')}","userId":"@{item.attributes.accountId}"}},"outputs":[{"name":"success","destination":"save_user_insights"}],"itemAttributes":{},"x":1890,"y":120},{"type":"InsertMapIntoDB","name":"save_user_insights","properties":{"tableName":"UserInsight","batchSize":200},"outputs":[],"itemAttributes":{},"x":2160,"y":120},{"type":"DeleteFromDB","name":"clean_media","properties":{"tableName":"Media","predicates":[{"field":"is_story","value":"@{false}","operator":"="},{"field":"ownerId","value":"@{item.attributes.accountId}","operator":"="}]},"outputs":[{"name":"success","destination":"clean_media_insight"}],"itemAttributes":{},"x":810,"y":240},{"type":"DeleteFromDB","name":"clean_media_insight","properties":{"tableName":"MediaInsight","predicates":[{"field":"timestamp","operator":">=","value":"@{currentDate().atStartOfDay()}"}]},"outputs":[{"name":"success","destination":"get_media"},{"name":"success","destination":"get_carousels"}],"itemAttributes":{},"x":1080,"y":240},{"type":"FacebookGraph","name":"get_media","properties":{"url":"@{item.attributes.accountId}/media","isSingleObject":true,"fields":["caption","timestamp","comments_count","id","ig_id","is_comment_enabled","like_count","media_type","media_url","owner","permalink","shortcode","thumbnail_url","insights.metric(engagement,reach,impressions,saved,carousel_album_saved).period(lifetime)","comments{hidden,id,like_count,media,text,timestamp,user}","children{id,ig_id,media_type,media_url,permalink,shortcode,timestamp}"]},"outputs":[{"name":"success","destination":"split_media"}],"itemAttributes":{},"x":1350,"y":240},{"type":"FacebookGraph","name":"get_carousels","properties":{"url":"@{item.attributes.accountId}/media","isSingleObject":true,"fields":["caption","timestamp","comments_count","id","ig_id","is_comment_enabled","like_count","media_type","media_url","owner","permalink","shortcode","thumbnail_url","children{id,ig_id,media_type,media_url,permalink,shortcode,timestamp}","insights.metric(carousel_album_engagement,carousel_album_reach,carousel_album_video_views,carousel_album_impressions,carousel_album_saved,engagement,reach,impressions).period(lifetime)"]},"outputs":[{"name":"success","destination":"split_carousel"}],"itemAttributes":{},"x":1350,"y":720},{"type":"SplitJsonArray","name":"split_carousel","properties":{"propertyJsonArray":"@{evalJson(item, '$.data')}"},"outputs":[{"name":"success","destination":"map_carousel_insights"}],"itemAttributes":{"ownerId":"@{evalJson(item, '$.owner.id')}","parentId":"@{evalJson(item, '$.id')}"},"x":1620,"y":720},{"type":"ToMap","name":"map_carousel_insights","properties":{"mappings":{"engagement":"@{?evalJson(item, '$.insights.data[?(@.name==\\'engagement\\')].values[0].value').get(0)}","reach":"@{?evalJson(item, '$.insights.data[?(@.name==\\'reach\\')].values[0].value').get(0)}","impressions":"@{?evalJson(item, '$.insights.data[?(@.name==\\'impressions\\')].values[0].value').get(0)}","saved":"@{?evalJson(item, '$.insights.data[?(@.name==\\'saved\\')].values[0].value').get(0)}","carousel_album_impressions":"@{?evalJson(item, '$.insights.data[?(@.name==\\'carousel_album_impressions\\')].values[0].value').get(0)}","carousel_album_video_views":"@{?evalJson(item, '$.insights.data[?(@.name==\\'video_views\\')].values[0].value').get(0)}","carousel_album_reach":"@{?evalJson(item, '$.insights.data[?(@.name==\\'carousel_album_reach\\')].values[0].value').get(0)}","carousel_album_engagement":"@{?evalJson(item, '$.insights.data[?(@.name==\\'carousel_album_engagement\\')].values[0].value').get(0)}","timestamp":"@{now()}","mediaId":"@{evalJson(item, '$.id')}"}},"outputs":[{"name":"success","destination":"save_mdeia_insights"}],"itemAttributes":{},"x":1890,"y":720},{"type":"SplitJsonArray","name":"split_carousel_children","properties":{"propertyJsonArray":"@{evalJson(item, '$.children.data')}"},"outputs":[{"name":"success","destination":"map_carousel_children"}],"itemAttributes":{},"x":1890,"y":240},{"type":"JsonToMap","name":"map_carousel_children","properties":{"mappings":{"timestamp":"@{toDateTime(evalJson(item, '$.timestamp'), 'yyyy-MM-dd\\'T\\'HH:mm:ssZ')}","is_story":"@{false}","ownerId":"@{item.attributes.ownerId}","parentId":"@{item.attributes.parentId}"}},"outputs":[{"name":"success","destination":"save_carousel_children"}],"itemAttributes":{},"x":2160,"y":240},{"type":"InsertMapIntoDB","name":"save_carousel_children","properties":{"tableName":"Media","batchSize":200},"outputs":[],"itemAttributes":{},"x":2430,"y":240},{"type":"SplitJsonArray","name":"split_media","properties":{"propertyJsonArray":"@{evalJson(item, '$.data')}"},"outputs":[{"name":"success","destination":"map_media"},{"name":"success","destination":"map_media_insights"},{"name":"success","destination":"split_media_comments"},{"name":"success","destination":"split_carousel_children"}],"itemAttributes":{"ownerId":"@{evalJson(item, '$.owner.id')}","parentId":"@{evalJson(item, '$.id')}"},"x":1620,"y":240},{"type":"SplitJsonArray","name":"split_media_comments","properties":{"propertyJsonArray":"@{evalJson(item, '$.comments.data')}"},"outputs":[{"name":"success","destination":"map_comments"}],"itemAttributes":{},"x":1890,"y":360},{"type":"JsonToMap","name":"map_comments","properties":{"mappings":{"mediaId":"@{evalJson(item, '$.media.id')}","userId":"@{evalJson(item, '$.user.id')}","timestamp":"@{toDateTime(evalJson(item, '$.timestamp'), 'yyyy-MM-dd\\'T\\'HH:mm:ssZ')}"},"excludes":["media","user"]},"outputs":[{"name":"success","destination":"save_comments"}],"itemAttributes":{},"x":2160,"y":360},{"type":"InsertMapIntoDB","name":"save_comments","properties":{"tableName":"Comment","batchSize":200},"outputs":[],"itemAttributes":{},"x":2430,"y":360},{"type":"JsonToMap","name":"map_media_insights","properties":{"mappings":{"engagement":"@{?evalJson(item, '$.insights.data[?(@.name==\\'engagement\\')].values[0].value').get(0)}","reach":"@{?evalJson(item, '$.insights.data[?(@.name==\\'reach\\')].values[0].value').get(0)}","impressions":"@{?evalJson(item, '$.insights.data[?(@.name==\\'impressions\\')].values[0].value').get(0)}","saved":"@{?evalJson(item, '$.insights.data[?(@.name==\\'saved\\')].values[0].value').get(0)}","timestamp":"@{now()}","mediaId":"@{evalJson(item, '$.id')}"},"excludes":["ig_id","children","shortcode","media_url","is_comment_enabled","media_type","comments_count","id","permalink","owner","like_count","insights","comments","caption"]},"outputs":[{"name":"success","destination":"save_mdeia_insights"}],"itemAttributes":{},"x":1890,"y":480},{"type":"InsertMapIntoDB","name":"save_mdeia_insights","properties":{"tableName":"MediaInsight","batchSize":200},"outputs":[],"itemAttributes":{},"x":2160,"y":720},{"type":"JsonToMap","name":"map_media","properties":{"mappings":{"timestamp":"@{toDateTime(evalJson(item, '$.timestamp'), 'yyyy-MM-dd\\'T\\'HH:mm:ssZ')}","is_story":"@{false}","ownerId":"@{evalJson(item, '$.owner.id')}"},"excludes":["comments","children","owner","insights","children"]},"outputs":[{"name":"success","destination":"save_media"}],"itemAttributes":{},"x":1890,"y":600},{"type":"InsertMapIntoDB","name":"save_media","properties":{"tableName":"Media","batchSize":200},"outputs":[],"itemAttributes":{},"x":2160,"y":600},{"type":"FacebookGraph","name":"get_stories","properties":{"url":"@{item.attributes.accountId}/stories","isSingleObject":true,"fields":["caption","timestamp","comments_count","id","ig_id","is_comment_enabled","like_count","media_type","media_url","owner","permalink","shortcode","thumbnail_url","insights.metric(exits,impressions,reach,replies,taps_forward,taps_back).period(lifetime)"]},"outputs":[{"name":"success","destination":"split_stories"}],"itemAttributes":{},"x":810,"y":840},{"type":"SplitJsonArray","name":"split_stories","properties":{"propertyJsonArray":"@{evalJson(item, '$.data')}"},"outputs":[{"name":"success","destination":"clean_stories"},{"name":"success","destination":"clean_story_insights"}],"itemAttributes":{},"x":1080,"y":840},{"type":"DeleteFromDB","name":"clean_story_insights","properties":{"tableName":"StoryInsight","predicates":[{"field":"storyId","operator":"=","value":"@{evalJson(item, '$.id')}"},{"field":"timestamp","operator":">=","value":"@{currentDate().atStartOfDay()}"}]},"outputs":[{"name":"success","destination":"map_story_insights"}],"itemAttributes":{},"x":1350,"y":840},{"type":"DeleteFromDB","name":"clean_stories","properties":{"tableName":"Media","predicates":[{"field":"id","operator":"=","value":"@{evalJson(item, '$.id')}"}]},"outputs":[{"name":"success","destination":"map_stories"}],"itemAttributes":{},"x":1350,"y":960},{"type":"JsonToMap","name":"map_story_insights","properties":{"excludes":["ig_id","shortcode","media_url","is_comment_enabled","media_type","comments_count","id","permalink","owner","like_count","insights"],"mappings":{"storyId":"@{evalJson(item, '$.id')}","exits":"@{?evalJson(item, '$.insights.data[?(@.name==\\'exits\\')].values[0].value').get(0)}","impressions":"@{?evalJson(item, '$.insights.data[?(@.name==\\'impressions\\')].values[0].value').get(0)}","reach":"@{?evalJson(item, '$.insights.data[?(@.name==\\'reach\\')].values[0].value').get(0)}","replies":"@{?evalJson(item, '$.insights.data[?(@.name==\\'replies\\')].values[0].value').get(0)}","taps_forward":"@{?evalJson(item, '$.insights.data[?(@.name==\\'taps_forward\\')].values[0].value').get(0)}","taps_back":"@{?evalJson(item, '$.insights.data[?(@.name==\\'taps_back\\')].values[0].value').get(0)}","timestamp":"@{now()}"}},"outputs":[{"name":"success","destination":"change_story_insights"}],"itemAttributes":{},"x":1620,"y":840},{"type":"Modify","name":"change_story_insights","properties":{"value":{"timestamp":"@{item.content.timestamp}","storyId":"@{item.content.storyId}","exits":"@{item.content.exits >= 0 ? item.content.exits : 0}","replies":"@{item.content.replies >= 0 ? item.content.replies : 0}","reach":"@{item.content.reach >= 0 ? item.content.reach : 0}","impressions":"@{item.content.impressions >= 0 ? item.content.impressions : 0}","taps_back":"@{item.content.taps_back >= 0 ? item.content.taps_back : 0}","taps_forward":"@{item.content.taps_forward >= 0 ? item.content.taps_forward : 0}"}},"outputs":[{"name":"success","destination":"save_story_insights"}],"itemAttributes":{},"x":1890,"y":840},{"type":"InsertMapIntoDB","name":"save_story_insights","properties":{"tableName":"StoryInsight","batchSize":200},"itemAttributes":{},"x":2160,"y":840},{"type":"JsonToMap","name":"map_stories","properties":{"mappings":{"ownerId":"@{evalJson(item, '$.owner.id')}","is_story":"@{true}","timestamp":"@{toDateTime(evalJson(item, '$.timestamp'), 'yyyy-MM-dd\\'T\\'HH:mm:ssZ')}"},"excludes":["insights","owner"]},"outputs":[{"name":"success","destination":"save_stories"}],"itemAttributes":{},"x":1620,"y":960},{"type":"InsertMapIntoDB","name":"save_stories","properties":{"tableName":"Media","batchSize":200},"outputs":[],"itemAttributes":{},"x":1890,"y":960},{"type":"DeleteFromDB","name":"delete_accounts_and_comments","properties":{"tables":["User","Comment"]},"outputs":[{"name":"success","destination":"split_insta_accounts"}],"itemAttributes":{},"x":270,"y":0},{"type":"FacebookGraph","name":"get_fb_account","properties":{"url":"me/accounts","isSingleObject":true,"fields":["instagram_business_account","name"]},"outputs":[{"name":"success","destination":"delete_accounts_and_comments"}],"itemAttributes":{},"x":0,"y":0}],"excludes":["get_carousels","delete_accounts_and_comments"],"generalSteps":[{"type":"GetIntervals","name":"analytic_intervals","properties":{"totalMonths":3,"batchDays":90,"daysToExtract":3},"itemAttributes":{"from":"@{item.content.from}","until":"@{item.content.until}"}}]},"extractor":{"id":0,"timePeriod":0,"active":false,"errorCounter":0},"connectorCredentials":{"id":0,"organizationId":35,"datasourceId":616,"refreshToken":"EAAGuoVILSX4BAJPZC3Gh6GejhSNOaT4mG4UQGRXARAEqX33nLKXUUoyEDLDvLynfaOB0arNm4DB3py0q13IdjKAEKGkT70gjwaOA7RfjwOm1X7TEKmRc4XQxMlLVKZBpDZBo5Dr2HECBJs07KlKo5ltT1nJa2yNFmXSQwhiSAZDZD","datamart":"localhost","config":{"properties":{"pageId":"100230508074773910534","domain":"mettrr","customFields":[{"id":360001124611,"title":"3rd Line Tech Support (UK) Type of Change/Request"},{"id":360001486852,"title":"3rd Line Adwords management Type of Change/Request"},{"id":360001486872,"title":"3rd Line Product support Type of Change/Request"},{"id":360001063512,"title":"2nd Line Legacy CWT Type of Change/Request"},{"id":360002165852,"title":"Mark as Spam"},{"id":360001063532,"title":"3rd Line Accounts and Admin (UK) Type of Change/Request"},{"id":360001062512,"title":"2nd Line CWT Type of Change/Request"},{"id":360001123991,"title":"1st Line Type of Change/Request"},{"id":360001124771,"title":"3rd Line Content (UK) Type of Change/Request"},{"id":360001227172,"title":"Country"},{"id":360001124011,"title":"2nd Line CTT Type of Change/Request"},{"id":360001227992,"title":"Phone Number - Only from form submission"}],"clientCustomerIds":["8670301477"],"reports":["PLACEHOLDER_REPORT_Normal","PLACEMENT_PERFORMANCE_REPORT_Normal","PRODUCT_PARTITION_REPORT_Normal","SEARCH_QUERY_PERFORMANCE_REPORT_Normal","SHOPPING_PERFORMANCE_REPORT_ConversionSegmented","SHOPPING_PERFORMANCE_REPORT_Normal","TOP_CONTENT_PERFORMANCE_REPORT_Normal","URL_PERFORMANCE_REPORT_ConversionSegmented","URL_PERFORMANCE_REPORT_Normal","USER_AD_DISTANCE_REPORT_Normal","VIDEO_PERFORMANCE_REPORT_ConversionSegmented","VIDEO_PERFORMANCE_REPORT_Normal"]},"to":[],"oauthAccessTokenSecret":"oLZCb0LjGWAmmTONV8ciiz9f6ng488dncQps2h1eo2s2D"}}}